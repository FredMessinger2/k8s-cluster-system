{% extends "base.html" %}

{% block title %}Dashboard - K8s Cluster Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Kubernetes Cluster Dashboard</h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Pods</h5>
                <h2 class="text-primary" id="pod-count">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Deployments</h5>
                <h2 class="text-success" id="deployment-count">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Cache Age</h5>
                <h2 class="text-info" id="cache-age">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Status</h5>
                <span class="badge bg-secondary" id="status-badge">Loading...</span>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="refreshCache()">Refresh</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Pods by Status</h5>
            </div>
            <div class="card-body">
                <div id="pod-status-chart"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Cache Statistics</h5>
            </div>
            <div class="card-body">
                <div id="cache-stats"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Pods</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="pods-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Namespace</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="pods-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let refreshInterval;

function updateDashboard() {
    // Fetch cluster data
    fetch('/api/cluster-data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                document.getElementById('status-badge').textContent = 'Error';
                document.getElementById('status-badge').className = 'badge bg-danger';
                return;
            }

            // Update counts
            document.getElementById('pod-count').textContent = data.podCount || 0;
            document.getElementById('deployment-count').textContent = data.deploymentCount || 0;
            
            // Update pods table
            updatePodsTable(data.pods || []);
            
            // Update status
            document.getElementById('status-badge').textContent = 'Connected';
            document.getElementById('status-badge').className = 'badge bg-success';
        })
        .catch(error => {
            console.error('Error fetching cluster data:', error);
            document.getElementById('status-badge').textContent = 'Disconnected';
            document.getElementById('status-badge').className = 'badge bg-danger';
        });

    // Fetch cache stats
    fetch('/api/cache-stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                const ageMs = data.cacheAge || 0;
                const ageSeconds = Math.floor(ageMs / 1000);
                document.getElementById('cache-age').textContent = ageSeconds + 's';
                
                // Update cache stats display
                const statsDiv = document.getElementById('cache-stats');
                statsDiv.innerHTML = `
                    <p><strong>Valid:</strong> ${data.isValid ? 'Yes' : 'No'}</p>
                    <p><strong>Entries:</strong> ${data.entryCount || 0}</p>
                    <p><strong>Last Updated:</strong> ${new Date(data.lastUpdated || 0).toLocaleTimeString()}</p>
                `;
            }
        })
        .catch(error => console.error('Error fetching cache stats:', error));
}

function updatePodsTable(pods) {
    const tbody = document.getElementById('pods-tbody');
    tbody.innerHTML = '';
    
    pods.slice(0, 10).forEach(pod => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${pod.name}</td>
            <td>${pod.namespace}</td>
            <td><span class="badge ${getStatusBadgeClass(pod.status)}">${pod.status}</span></td>
            <td>${formatTimestamp(pod.creationTimestamp)}</td>
        `;
    });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'Running': return 'bg-success';
        case 'Pending': return 'bg-warning';
        case 'Failed': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp).toLocaleString();
}

function refreshCache() {
    fetch('/api/refresh-cache', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            console.log('Cache refresh triggered:', data);
            // Refresh dashboard after a moment
            setTimeout(updateDashboard, 1000);
        })
        .catch(error => console.error('Error refreshing cache:', error));
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    updateDashboard();
    // Refresh every 10 seconds
    refreshInterval = setInterval(updateDashboard, 10000);
});
</script>
{% endblock %}
